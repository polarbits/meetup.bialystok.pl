{"version":3,"sources":["../../src/utils/error-response.js"],"names":["process","noDeprecation","on","reason","p","name","status","errors","detail","errorMessage","cyan","message","fileIssue","env","NODE_ENV","CLI_SHOW_STACK","console","log","stack","ErrorResponse","constructor","context","contextName","toLowerCase","session","checkErrorType","err","errno","handleRequestError","url","has","response","request","green","handleSystemError","code","path","captureException","account","settings","attributes","auth_key","setContext","user","handle","errorType","handleError","requestError","systemError","default"],"mappings":"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","file":"error-response.js","sourcesContent":["import Raven from 'raven'\nimport format from 'chalk'\nimport _ from 'lodash'\nimport { error, echo } from './print-tools'\n\nprocess.noDeprecation = true\n\nprocess.on('unhandledRejection', (reason, p) => {\n  if (reason.name === 'RequestError' && reason.status === 403) {\n    if (reason.errors.detail === 'No such API Key.') {\n      const errorMessage =\n        `API key from your config file is not valid. Use ${format.cyan('syncano-cli login')} to log in once again.`\n      echo(errorMessage)\n      echo()\n      return\n    }\n  }\n\n  const message = `Unhandled Rejection! ${reason}`\n  const fileIssue = 'Please file an issue here:\\nhttps://github.com/Syncano/syncano-node-cli/issues'\n  error(message, fileIssue)\n  if (process.env.NODE_ENV === 'test' || process.env.CLI_SHOW_STACK) {\n    console.log(reason.stack)\n  }\n})\n\nclass ErrorResponse {\n  constructor (context) {\n    this.context = context\n    this.name = context.name\n    this.contextName = context.constructor.name.toLowerCase()\n    this.session = this.context.session || null\n  }\n  static checkErrorType (err) {\n    if (err.name === 'RequestError') return 'requestError'\n    if (err.errno < 0) return 'systemError'\n\n    return 'default'\n  }\n  static handleRequestError (err, name, contextName) {\n    if (err.status === 404) {\n      const errorMessage = `\"${name}\" ${contextName} could not be found on your remote Syncano account!`\n\n      const url = _.has(err, 'response.request.url')\n        ? `We've tried reaching the following url: ${err.response.request.url}` : null\n\n      error(err, errorMessage, url)\n      echo()\n      echo(`Did you run ${format.green('syncano-cli deploy')} command?`)\n      return\n    }\n    error(err)\n  }\n\n  static handleSystemError (err, name, contextName) {\n    if (err.code === 'ENOENT') {\n      error('File or directory not found at:', err.path)\n      return\n    }\n    error(err)\n  }\n\n  captureException (err) {\n    const context = this.context\n    const session = context.session\n\n    if (session) {\n      const account = session.settings.account\n      delete account.attributes.auth_key\n      Raven.setContext({ user: { session, account } })\n    } else {\n      Raven.setContext({ user: { context } })\n    }\n\n    Raven.captureException(err)\n  }\n\n  handle (err) {\n    const name = this.name\n    const contextName = this.contextName\n    const errorType = ErrorResponse.checkErrorType(err)\n\n    this.captureException(err)\n    const handleError = {\n      requestError: () => ErrorResponse.handleRequestError(err, name, contextName),\n      systemError: () => ErrorResponse.handleSystemError(err, name, contextName),\n      default: () => error(err)\n    }\n\n    return handleError[errorType]()\n  }\n}\n\nexport default ErrorResponse\n"]}